# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1QotKljL0enLRlmL6sYU77SAxJ640xhjH
"""

import os
import re
from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
from youtube_transcript_api import YouTubeTranscriptApi
import google.generativeai as genai

app = Flask(__name__)

# ==========================================
# è¨­å®šå€ï¼šå¾ Render çš„ç’°å¢ƒè®Šæ•¸è®€å– Key
# ==========================================
# é€™äº›è®Šæ•¸éœ€è¦åœ¨ Render çš„ Dashboard ä¸­è¨­å®šï¼Œä¸è¦ç›´æ¥å¯«åœ¨ç¨‹å¼ç¢¼è£¡
LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_CHANNEL_SECRET = os.environ.get('LINE_CHANNEL_SECRET')
GOOGLE_API_KEY = os.environ.get('GOOGLE_API_KEY')

# åˆå§‹åŒ– LINE Bot
if LINE_CHANNEL_ACCESS_TOKEN is not None:
    line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
    handler = WebhookHandler(LINE_CHANNEL_SECRET)
else:
    # é¿å…æœ¬åœ°æ¸¬è©¦æ™‚è‹¥æ²’æœ‰è¨­ç’°å¢ƒè®Šæ•¸æœƒç›´æ¥å ±éŒ¯ï¼Œé€™è£¡åšå€‹ç°¡å–®é˜²å‘†
    print("è­¦å‘Šï¼šæœªè®€å–åˆ° LINE Tokenï¼Œè«‹ç¢ºèªç’°å¢ƒè®Šæ•¸æ˜¯å¦è¨­å®šã€‚")
    line_bot_api = None
    handler = None

# åˆå§‹åŒ– Google Gemini
if GOOGLE_API_KEY:
    genai.configure(api_key=GOOGLE_API_KEY)
    model = genai.GenerativeModel('gemini-1.5-flash')
else:
    print("è­¦å‘Šï¼šæœªè®€å–åˆ° Google API Keyã€‚")

# ==========================================
# è·¯ç”±å€
# ==========================================

# 1. å¥åº·æª¢æŸ¥è·¯ç”± (è®“ Render çŸ¥é“ç¨‹å¼é‚„æ´»è‘—ï¼Œä¹Ÿçµ¦ UptimeRobot ç”¨)
@app.route("/")
def home():
    return "Hello, Line Bot is running! (Youtube Summary Bot)"

# 2. LINE Webhook å…¥å£
@app.route("/callback", methods=['POST'])
def callback():
    if handler is None:
        return 'Error: LINE Bot config is missing', 500

    signature = request.headers['X-Line-Signature']
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'

# ==========================================
# é‚è¼¯å€
# ==========================================

# ç¢ºä¿ handler å­˜åœ¨æ‰è¨»å†Šäº‹ä»¶ (é¿å…æœ¬åœ°æ²’è¨­ Key æ™‚å ±éŒ¯)
if handler:
    @handler.add(MessageEvent, message=TextMessage)
    def handle_message(event):
        msg = event.message.text

        # ä½¿ç”¨æ­£è¦è¡¨é”å¼æª¢æŸ¥æ˜¯å¦åŒ…å« YouTube é€£çµ
        youtube_pattern = r'(https?://)?(www\.)?(youtube\.com|youtu\.be)/[\w-]+'
        match = re.search(youtube_pattern, msg)

        if match:
            video_url = match.group(0)
            print(f"æ”¶åˆ°å½±ç‰‡é€£çµ: {video_url}")

            try:
                # 1. å–å¾— Video ID
                video_id = extract_video_id(video_url)

                # 2. æŠ“å–å­—å¹• (å˜—è©¦æŠ“å–ç¹ä¸­ã€ç°¡ä¸­ã€è‹±æ–‡)
                # æ³¨æ„ï¼šå¦‚æœå½±ç‰‡å®Œå…¨æ²’æœ‰ CC å­—å¹•ï¼Œé€™ä¸€æ­¥æœƒå ±éŒ¯
                transcript_list = YouTubeTranscriptApi.get_transcript(
                    video_id,
                    languages=['zh-TW', 'zh-Hant', 'zh-CN', 'zh-Hans', 'en']
                )

                # 3. çµ„åˆå­—å¹•æ–‡å­—
                full_text = " ".join([t['text'] for t in transcript_list])

                # 4. å‘¼å« Gemini é€²è¡Œæ‘˜è¦
                if not GOOGLE_API_KEY:
                    reply_text = "éŒ¯èª¤ï¼šä¼ºæœå™¨ç«¯æœªè¨­å®š Google API Keyï¼Œç„¡æ³•é€²è¡Œæ‘˜è¦ã€‚"
                else:
                    reply_text = get_gemini_summary(full_text)

                # 5. å›è¦† LINE
                line_bot_api.reply_message(
                    event.reply_token,
                    TextSendMessage(text=f"ğŸ“º å½±ç‰‡æ‘˜è¦ï¼š\n\n{reply_text}")
                )

            except Exception as e:
                print(f"Error processing video: {e}")
                error_msg = "ç„¡æ³•å–å¾—å­—å¹•ï¼Œå¯èƒ½æ˜¯è©²å½±ç‰‡æ²’æœ‰æä¾› CC å­—å¹•åŠŸèƒ½ï¼Œæˆ–æ˜¯é€£çµç„¡æ•ˆã€‚"
                line_bot_api.reply_message(
                    event.reply_token,
                    TextSendMessage(text=error_msg)
                )

def extract_video_id(url):
    """å¾ç¶²å€ä¸­æå– YouTube Video ID"""
    if "youtu.be" in url:
        return url.split("/")[-1].split("?")[0]
    else:
        # è™•ç† watch?v= ä»¥åŠå¯èƒ½å­˜åœ¨çš„å…¶ä»–åƒæ•¸
        try:
            return url.split("v=")[1].split("&")[0]
        except:
            return url.split("/")[-1]

def get_gemini_summary(text):
    """å‘¼å« Google Gemini API ç”¢ç”Ÿæ‘˜è¦"""
    prompt = f"""
    ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å½±ç‰‡æ‘˜è¦åŠ©æ‰‹ã€‚
    è«‹é–±è®€ä»¥ä¸‹çš„å½±ç‰‡å­—å¹•ï¼Œä¸¦ç”¨ç¹é«”ä¸­æ–‡å®Œæˆä»¥ä¸‹ä»»å‹™ï¼š
    1. ã€æ¨™é¡Œã€‘ï¼šç”¨ä¸€å¥è©±æ¦‚æ‹¬å½±ç‰‡ä¸»æ—¨ã€‚
    2. ã€é‡é»ã€‘ï¼šåˆ—å‡º 3-5 å€‹é—œéµé‡é» (ä½¿ç”¨æ¢åˆ—å¼ï¼Œä¸¦åŠ ä¸Šé©ç•¶çš„ emoji)ã€‚
    3. ã€çµè«–ã€‘ï¼šçµ¦å‡ºä¸€å€‹ç°¡çŸ­çš„ç¸½çµã€‚

    ---
    å½±ç‰‡å­—å¹•å…§å®¹ï¼š
    {text}
    """
    try:
        response = model.generate_content(prompt)
        return response.text
    except Exception as e:
        return f"AI æ‘˜è¦ç”Ÿæˆå¤±æ•—: {str(e)}"

if __name__ == "__main__":
    app.run()